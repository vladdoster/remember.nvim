name: Test

on:
  pull_request:
    branches: [ master, main ]
  push:
    branches: [ master, main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Lua and LuaRocks
        run: |
          sudo apt-get update
          sudo apt-get install -y lua5.1 liblua5.1-0-dev luarocks
      
      - name: Install test dependencies
        run: |
          luarocks install busted --local
          luarocks install luacov --local
      
      - name: Run tests with coverage
        run: |
          export PATH="$HOME/.luarocks/bin:$PATH"
          busted tests/ --coverage
          
      - name: Generate coverage report
        run: |
          eval $(luarocks path)
          luacov
          
      - name: Extract coverage percentage
        id: coverage
        run: |
          if [ -f luacov.report.out ]; then
            # Extract coverage percentage from the summary line
            # Look for pattern like "44   1      97.78%" in the Total line
            COVERAGE=$(grep "^Total" luacov.report.out | awk '{print $NF}' | tr -d '%' || echo "")
            
            # Fallback: if Total line not found, try older format
            if [ -z "$COVERAGE" ]; then
              COVERAGE=$(grep -A 2 "^Summary$" luacov.report.out | tail -n 1 | awk '{print $NF}' | tr -d '%' || echo "")
            fi
            
            # Validate that we got a valid number (integer or decimal)
            if [[ "$COVERAGE" =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
              echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
              echo "Coverage: $COVERAGE%"
            else
              echo "Warning: Could not extract valid coverage percentage from report, defaulting to 0"
              echo "percentage=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "percentage=0" >> $GITHUB_OUTPUT
            echo "Coverage report not found"
          fi
      
      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const coverage = '${{ steps.coverage.outputs.percentage }}';
            const fs = require('fs');
            
            let coverageReport = '';
            if (fs.existsSync('luacov.report.out')) {
              coverageReport = fs.readFileSync('luacov.report.out', 'utf8');
            }
            
            const body = `## ðŸ“Š Test Coverage Report
            
            **Overall Coverage:** ${coverage}%
            
            <details>
            <summary>ðŸ“‹ Detailed Coverage Report</summary>
            
            \`\`\`
            ${coverageReport}
            \`\`\`
            
            </details>
            
            ---
            *Coverage report generated by [luacov](https://github.com/lunarmodules/luacov)*
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Test Coverage Report')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
      
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            luacov.report.out
            luacov.stats.out
